<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">

    <title>D3 Field Planting</title>

    <!-- load D3 -->
<!--     <script src="https://rawcdn.githack.com/coopbri/hci-binder/362464110b5273593e9fdd1dc1c0ae3e4f1da224/lib/d3.min.js"></script> -->
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.10.2/d3.js"></script>
<!--     <script type="text/javascript"> -->
    <!-- global styles -->
    <style>
      body     { font-family: helvetica, sans-serif;
                 -moz-user-select: none;
                 -webkit-user-select: none;
                 -ms-user-select: none;
                 user-select: none; }
      svg      { float:left;
                 margin-right: 80px; }
      #control { width: 240px;
                 text-align: center;
                 margin-top: 10px;
                 position: absolute;
                 display: inline-block; }
      button   { margin: 0 5px;
                 padding: 3px; }
      #start   { margin-top: 20px; }
    </style>
  </head>

  <body>
    <script>
      var timer = d3.timer(function() { timer.stop(); });
      var body = d3.select("body");
      var svg = body.append("svg")
        .attr("width", 230)
        .attr("height", 300);
      var patterns = svg.append("defs").append("pattern")
        .attr("id", "seedling")
        .attr("patternUnits", "userSpaceOnUse")
        .attr("width", 100).attr("height", 100)

      patterns.append("image")
        .attr("xlink:href", "https://github.com/hourofci/lessons/blob/master/beginner-lessons/parallel-computing/supplementary/seedling.svg?raw=true")
        .attr("x", 0).attr("y", 0)
        .attr("width", 100).attr("height", 100)

      // generate grid of nodes (field cells)
      function grid() {
        var grid = new Array();
        var xpos = 10;
        var ypos = 45;
        var width = 30;
        var height = 30;

        // draw farmland
        for (var row = 0; row < 6; row++) {
          for (var column = 0; column < 6; column++) {
            grid.push( new Array());
            grid[column].push({
              x: xpos,
              y: ypos,
              width: width,
              height: height,
            })
            xpos += width+5;
          }
          // reset x and y
          xpos = 10;
          ypos += height+5;
        }
        return grid;
      } // end grid generation function

      var farm = grid();

      var row = svg.selectAll(".row")
        .data(farm)
        .enter().append("g")
        .attr("id", function (d, i) { return "col" + i; });

      var column = row.selectAll(".square")
        .data(function (d) { return d; })
        .enter().append("image")
        .attr("xlink:href", "https://github.com/hourofci/lessons/blob/master/beginner-lessons/parallel-computing/supplementary/empty.svg?raw=true")
        .attr("x", function (d) { return d.x; })
        .attr("y", function (d) { return d.y; })
        .attr("width", function (d) { return d.width; })
        .attr("height", function (d) { return d.height; })
        .attr("id", function (d, i) { return "cell" + i; })
        .classed("plot", true);

        // remove extra g tags generated by grid
        var extra = d3.selectAll("g").filter(function() {
          var col = this.id;
          var c = col.substr(3);
          return c > 5;
        });
        extra.remove();

      // draw farmer
      svg.append("image").attr("xlink:href", "https://github.com/hourofci/lessons/blob/master/beginner-lessons/parallel-computing/supplementary/farmer.svg?raw=true")
        .attr("id", "farmer")
        .attr("width", 40)
        .attr("x", 0);

      body.append("br");

      var control = body.append("div").attr("id", "control");

      var stats = control.append("div")
        .style("border", "solid 3px #c1272d")
        .style("color", "#c1272d");

      stats.append("p").text("Sam")
        .style("text-decoration", "underline")
        .style("font-weight", 600);

      // speed control buttons
      stats.append("p").attr("id", "speed").text("Speed: fast");
      var speed = 100;
      stats.append("button").text("Slow")
        .on("click", function() {
          speed = 750;
          d3.select("#speed").text("Speed: slow");
        });
      stats.append("button").text("Medium")
        .on("click", function() {
          speed = 500;
          d3.select("#speed").text("Speed: medium");
        });
      stats.append("button").text("Fast")
        .on("click", function() {
          speed = 100;
          d3.select("#speed").text("Speed: fast");
        });

      // counter value display
      stats.append("p").attr("id", "counter")
        .text("Duration: " + 0 + " seconds");

      // start automatic planting
      var dist = 36;
      var i = 0;
      var j = 0;
      control.append("button").text("Start").attr("id", "start").on("click", function() {
        // start timer
        var stop = false;
        timer.restart(function(dur) {
          d3.select("#counter").text(function() {
            var time = Math.floor(dur / 1000);
            if (time === 1) { return "Duration: " + time + " second" }
            else { return "Duration: " + time + " seconds" }
          });
          if (stop) {
            timer.stop();
          }
        });

        d3.select(this).attr("disabled", true);
        d3.select("#reset").attr("disabled", null);
        interval = setInterval(function() {
          var farmer = d3.select("#farmer");
          var col = d3.select("#col" + i);
          col.select("#cell" + j).attr("xlink:href", "https://github.com/hourofci/lessons/blob/master/beginner-lessons/parallel-computing/supplementary/seedling.svg?raw=true");

          // check if row is even or odd
          if (j % 2 === 0) {
            i++;
            if (i !== 6) {
              farmer.attr("x", function(d) {
                return +d3.select(this).attr("x") + dist;
              });
            }
          } else {
            i--;
            if (i !== -1) {
              farmer.attr("x", function(d) {
                return +d3.select(this).attr("x") - dist;
              });
            }
          }

          // jump to next row upon reaching right end
          if (i === 6) {
              i = 5;
              j++;
              farmer.attr("y", function(d) {
                return +d3.select(this).attr("y") + dist;
              });
          }

          // jump to next row upon reaching left end
          if (i === -1) {
            i = 0;
            j++;
            farmer.attr("y", function(d) {
              return +d3.select(this).attr("y") + dist;
            });
          }

          // check if final cell is planted
          var finalrow = d3.select("#col0");
          if (finalrow.select("#cell5").attr("xlink:href") === "https://github.com/hourofci/lessons/blob/master/beginner-lessons/parallel-computing/supplementary/seedling.svg?raw=true") {
            clearInterval(interval);
          }
        }, speed);
      });

      // reset simulation
      control.append("button").text("Reset").attr("id", "reset")
        .attr("disabled", true)
        .on("click", function() {
          // reset timer and reset duration
          timer.stop();
          d3.select("#counter").text("Duration: " + 0 + " seconds");

          // clear farmer runtime code
          clearInterval(interval);

          // enable start button
          d3.select("#start").attr("disabled", null);

          // reset tiles and tile counters
          i = 0;
          j = 0;
          d3.selectAll("image.plot").attr("xlink:href", "https://github.com/hourofci/lessons/blob/master/beginner-lessons/parallel-computing/supplementary/empty.svg?raw=true");
          d3.select("#farmer").attr("x", 0).attr("y", 0);
          d3.select(this).attr("disabled", true);
      });
    </script>
  </body>
</html>
