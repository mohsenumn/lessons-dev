<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">

    <title>D3 Field Planting</title>

    <!-- load D3 -->
<!--     <script src="https://rawcdn.githack.com/coopbri/hci-binder/362464110b5273593e9fdd1dc1c0ae3e4f1da224/lib/d3.min.js"></script> -->
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.10.2/d3.js"></script>

    <!-- global styles -->
    <style>
      body     { font-family: helvetica, sans-serif;
                 -moz-user-select: none;
                 -webkit-user-select: none;
                 -ms-user-select: none;
                 user-select: none; }
      svg      { float:left;
                 margin-right: 80px; }
      #control { width: 240px;
                 text-align: center;
                 margin-top: 10px;
                 position: absolute;
                 display: inline-block; }
      button   { margin: 0 5px;
                 padding: 3px; }
      #reset   { margin-top: 20px; }
    </style>
  </head>

  <body>
    <script>
      var timer = d3.timer(function() { timer.stop(); });
      var body = d3.select("body");
      var svg = body.append("svg")
        .attr("width", 230)
        .attr("height", 300);
      var patterns = svg.append("defs").append("pattern")
        .attr("id", "seedling")
        .attr("patternUnits", "userSpaceOnUse")
        .attr("width", 100).attr("height", 100)
      var unplanted = 36;

      patterns.append("image")
        .attr("xlink:href", "https://github.com/hourofci/lessons/blob/master/beginner-lessons/parallel-computing/supplementary/seedling.svg?raw=true")
        .attr("x", 0).attr("y", 0)
        .attr("width", 100).attr("height", 100)

      // generate grid of nodes (field cells)
      function grid() {
        var grid = new Array();
        var xpos = 10;
        var ypos = 8;
        var width = 30;
        var height = 30;

        // draw farmland
        for (var row = 0; row < 6; row++) {
          for (var column = 0; column < 6; column++) {
            grid.push( new Array());
            grid[column].push({
              x: xpos,
              y: ypos,
              width: width,
              height: height,
            })
            xpos += width+5;
          }
          // reset x and y
          xpos = 10;
          ypos += height+5;
        }
        return grid;
      } // end grid generation function

      var farm = grid();

      var row = svg.selectAll(".row")
        .data(farm)
        .enter().append("g")
        .attr("id", function (d, i) { return "col" + i; });

      var column = row.selectAll(".square")
        .data(function (d) { return d; })
        .enter().append("image")
        .attr("xlink:href", "https://github.com/hourofci/lessons/blob/master/beginner-lessons/parallel-computing/supplementary/empty.svg?raw=true")
        .attr("x", function (d) { return d.x; })
        .attr("y", function (d) { return d.y; })
        .attr("width", function (d) { return d.width; })
        .attr("height", function (d) { return d.height; })
        .attr("id", function (d, i) { return "cell" + i; })
        .on("click", function() {
          d3.select("#reset").attr("disabled", null);
          unplanted--;
          d3.select(this).attr("xlink:href", "https://github.com/hourofci/lessons/blob/master/beginner-lessons/parallel-computing/supplementary/seedling.svg?raw=true");

          // start timer if first seedling planted
          if (unplanted === 35) {
            timer.restart(function(dur) {
                // all seedlings planted
                if (unplanted === 0) {
                  // stop timer
                  timer.stop();

                  // display message
                  d3.select(".success").transition().style("fill-opacity", 1);
                }
                else {
                  d3.select("#counter").text(function() {
                    var time = Math.floor(dur / 1000);
                    if (time === 1) { return "Duration: " + time + " second" }
                    else { return "Duration: " + time + " seconds" }
                  });
                }
            });
          }
        });

        // remove extra g tags generated by grid
        var extra = d3.selectAll("g").filter(function() {
          var col = this.id;
          var c = col.substr(3);
          return c > 5;
        });
        extra.remove();

      var control = body.append("div").attr("id", "control");

      var stats = control.append("div")
        .style("border", "solid 3px black")
        .style("color", "black");

      // counter value display
      stats.append("p").attr("id", "counter")
        .text("Duration: " + 0 + " seconds");

      // reset simulation
      control.append("button").text("Reset").attr("id", "reset")
        .attr("disabled", true)
        .on("click", function() {
          // reset timer and reset duration
          timer.stop();
          d3.select("#counter").text("Duration: " + 0 + " seconds");

          // clear success message
          d3.selectAll(".success").style("fill-opacity", 0);

          // reset tiles and unplanted counter
          unplanted = 36;
          d3.selectAll("image").attr("xlink:href", "https://github.com/hourofci/lessons/blob/master/beginner-lessons/parallel-computing/supplementary/empty.svg?raw=true");

          console.log(unplanted)

          // disable reset button
          d3.select(this).attr("disabled", true);
        });

        // success message
        svg.append("text").text("Great job!")
          .classed("success", true)
          .attr("fill", "lime")
          .attr("font-size", 24)
          .attr("x", 62)
          .attr("y", 240)
          .style("fill-opacity", 0);
    </script>
  </body>
</html>
